trigger:
- Development

pool:
  vmImage: 'ubuntu-latest'

# Dockerize and Deploy Laravel app to Azure Container Registry and App Service

variables:
  # Azure Container Registry and App Service details
  acrName: 'acrbackend'
  acrResourceGroup: 'RG-APP-DEV'
  acrLoginServer: '$(acrName).azurecr.io'
  appServiceName: 'dealgo-backend'
  appServicePlanName: 'asp-backend'
  appServiceResourceGroup: 'RG-APP-DEV'
  appServiceConnection: 'SC-RG-APP-DEV'

  # Docker image details
  imageName: 'dealgo-backend'
  imageTag: '$(Build.BuildNumber).$(Build.BuildId)'
  dockerfilePath: './Dockerfile'

stages:
  - stage: Build
    displayName: Build and Push Docker Image
    jobs:
      - job: Build
        displayName: Build and Push Docker Image
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: Build Docker image
            inputs:
              command: 'build'
              Dockerfile: '$(dockerfilePath)'
              tags: |
                $(imageName):$(imageTag)
                $(imageName):latest
              buildContext: '.'
              containerRegistry: '$(acrLoginServer)'
              includeLatestTag: true

          - task: Docker@2
            displayName: Push Docker image to Azure Container Registry
            inputs:
              command: 'push'
              containerRegistry: '$(acrLoginServer)'
              repository: '$(imageName)'
              tags: |
                $(imageTag)
                latest
            condition: succeeded()

  - stage: Deploy
    displayName: Deploy to Azure App Service
    dependsOn: Build
    jobs:
      - deployment: Deploy
        displayName: Deploy to Azure App Service
        environment:
          name: 'dev'
          resourceType: 'VirtualMachine'
        strategy:
          runOnce:
            deploy:
              steps:
              - task: AzureWebApp@1
                displayName: 'Azure Web App Deploy'
                inputs:
                  azureSubscription: '$(appServiceConnection)'
                  appType: 'webAppLinux'
                  appName: '$(appServiceName)'
                  runtimeStack: 'PHP|8.0'
                  package: '$(imageName):$(imageTag)'
                  startUpCommand: ''
